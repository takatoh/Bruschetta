<!doctype html>
<html>
  <title>Bruschetta</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons" rel="stylesheet" type="text/css">
  <link href="https://cdn.jsdelivr.net/npm/quasar@2.11.8/dist/quasar.prod.css" rel="stylesheet" type="text/css">
</head>

  <body>
    <div id="app">
      <div id="app">
        <div class="q-pa-none">
          <q-layout view="hHh LpR fff" container style="min-height: 100vh" class="shadow-2">
            <q-header class="bg-teal-9 q-px-xl q-py-sm">
              <q-toolbar class="q-gutter-sm">
                <q-toolbar-title>Bruschetta</q-toolbar-title>
              </q-toolbar>
            </q-header>

            <q-page-container>
              <q-page class="q-pa-none">
                <div class="bg-white text-teal q-px-xl q-py-sm" style="border-bottom: solid 1px">
                  <q-toolbar class="q-gutter-lg">
                    <q-btn flat label="Books" color="white text-teal" href="{{ url_for('index') }}"></q-btn>
                    <q-btn flat label="Add a book" color="white text-teal" href="{{ url_for('book_add') }}"></q-btn>
                    <q-btn flat label="Disposed" color="white text-teal" href="{{ url_for('book_list_disposed') }}"></q-btn>
                    <q-btn flat label="Categoires" color="white text-teal" href="{{ url_for('category_list') }}"></q-btn>
                    <q-btn flat label="Formats" color="white text-teal" href="{{ url_for('format_list') }}"></q-btn>
                    <q-space></q-space>
                  </q-toolbar>
                </div>

                {% for message in get_flashed_messages() %}
                  <div class="flash">{{ message }}</div>
                {% endfor %}

                {% block body %}{% endblock %}

              </q-page>
            </q-page-container>

            <q-footer class="bg-teal q-px-xl q-py-sm">
              <q-toolbar class="q-gutter-sm">
                <q-space></q-space>
                <div>Bruschetta<q-badge color="white text-teal">v0.3-alpha</q-badge></div>
              </q-toolbar>
            </q-footer>
          </q-layout>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quasar@2.11.8/dist/quasar.umd.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quasar@2.11.8/dist/lang/ja.umd.prod.js"></script>

    <script>
      const { createApp, ref, onMounted } = Vue

      const app = createApp({
        setup () {
          const bookId = ref(null)
          const title = ref('')
          const volume = ref('')
          const series = ref('')
          const seriesVolume = ref('')
          const author = ref('')
          const translator = ref('')
          const publisher = ref('')
          const category = ref('')
          const categoryOptions = ref([])
          const format = ref('')
          const formatOptions = ref([])
          const isbn = ref('')
          const publishedOn = ref('')
          const originalTitle = ref('')
          const note = ref('')
          const keyword = ref('')
          const disc = ref('')
          const disposed = ref(false)
          onMounted(() => {
            const categories = fetch('/api/categories/').then(res => res.json())
            const formats = fetch('/api/formats/').then(res => res.json())
            Promise.all([categories, formats]).then(result => {
              //console.log(result[1]['formats'])
              categoryOptions.value = result[0]['categories']
              formatOptions.value = result[1]['formats']
            })
            let bookIdElem
            try {
              bookIdElem = document.getElementById('bookId')
            } catch(e) {
              bookIdElem = false
            }
            console.log(bookIdElem)
            if (bookIdElem) {
              console.log(`/api/book/${bookIdElem.value}/`)
              fetch(`/api/book/${bookIdElem.value}/`)
              .then(res => res.json())
              .then(result => {
                //console.log(result['books'].length)
                const info = result['books'][0]
                //console.log(info['title'])
                bookId.value = info['id']
                title.value = info['title']
                volume.value = info['volume']
                series.value = info['series']
                seriesVolume.value = info['series_volume']
                author.value = info['author']
                translator.value = info['translator']
                publisher.value = info['publisher']
                category.value = info['category']
                format.value = info['format']
                isbn.value = info['isbn']
                publishedOn.value = info['published_on']
                originalTitle.value = info['original_title']
                note.value = info['note']
                keyword.value = info['keyword']
                disc.value = info['disk']
                disposed.value = info['disposed']
              })
            }
          })
          return {
            bookId,
            title,
            volume,
            series,
            seriesVolume,
            author,
            translator,
            publisher,
            category,
            categoryOptions,
            format,
            formatOptions,
            isbn,
            publishedOn,
            originalTitle,
            note,
            keyword,
            disc,
            disposed
          }
        },
        delimiters: [ '<<', '>>'],
        methods: {
          insertBookInfo () {
            const isbn = this.isbn
            fetch(`https://api.openbd.jp/v1/get?isbn=${isbn}`)
              .then(response => response.json())
              .then(result => {
                const summary = result[0].summary
                this.title = summary.title
                this.volume = summary.volume
                this.series = summary.series
                this.author = summary.author
                this.publisher = summary.publisher
            })
          },
          cancel() {
            this.cleanValues()
          },
          say(message) {
            alert(message)
          }
        }
      })

      app.use(Quasar)
      Quasar.lang.set(Quasar.lang.ja)
      app.mount('#app')
    </script>

  </body>
</html>
